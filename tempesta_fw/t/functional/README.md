# Functional Tests for TempestaFW

## Recommended configuration

Running tests during development process can cause crashes to TempestaFW.
Since TempestaFW is implemented as a set of kernel modules it is not convenient
to run testing framework on the same host. It is recommended to run testing
framework on a separated host.

Recommended test-beds:

- Fully distributed. 4 different hosts with their own roles are used. This
configuration isolates traffic generated by benchmark utilities and traffic
generators in test network. It is also able to detect hangs and crushes. This
configuration is the only recommended for performance and stress tests.
```
    ┌───────────────────┐
    │ Testing Framework │
    └──────┬────────────┘
           │
           │    Management over SSH
           ├─────────────────┬─────────────────┐
           │                 │                 │
    ┌──────┴─────┐    ┌──────┴─────┐    ┌──────┴─────┐
    │ Client     │    │ TempestaFW │    │ Web Server │
    └──────┬─────┘    └──────┬─────┘    └──────┬─────┘
           │                 │                 │
           └─────────────────┴─────────────────┘
            Separated network for test traffic
```

- With isolated testing framework. This preset have limited resources and
results of the performance tests may vary between runs. But much less resource
needed to run the tests.
```
    ┌───────────────────┐
    │ Testing Framework │
    └──────┬────────────┘
           │
           │ Management over SSH
           │
    ┌──────┴───────────────────────────┐
    │ Client + TempestaFW + Web Server │
    └──────────────────────────────────┘
```

It is also possible to run everything on the same host, but the configuration
is unreliable.

There is two different models of tests: workload tests and pure functional
tests. Workload tests uses fully functional HTTP benchmark programs (ab, siege,
wrk) and HTTP servers (Apache, nginx) to check TempestaFW behaviour. This type
of tests is used for schedulers, stress and performance testing.

Pure functional tests check internal logic. Here combined HTTP client-server
server is used. It sends HTTP messages to TempestaFW, analyses how they are
forwarded to server, and vice versa. [This tests are still under development.]


## Requirements

- Host for testing framework: `Pyhon3` and `pyhon3-paramiko`
- All hosts except previous one:  `grep`, `awk`, `sftp-server`
- Host for running clients: `wrk`
- Host for running TempestaFW: Linux kernel with Tempesta, TempestaFW sources
- Host for running server: `nginx`, web content directory accessible by nginx

Testing framework manages other hosts via SSH protocol, so the host running
testing framework must be able to be authenticated on other hosts by the key.
That can be done using `ssh-copy-id`.


## Run tests

### Configuration

Testing framework has a lot of options described in `tests_config.ini'.
You can create default tests configuration by calling:

```sh
$ ./run_tests.py -d
```
Or run next command to show an example of configuration:
```sh
$ ./run_tests.py -e
```

There is 4 sections in configuration: `General`, `Client`, `Tempesta`, `Server`.

#### General Section

`General` section describes the options related to testing framework itself.

`verbose`: verbose level of output:
- `0` - quiet mode, result of each test is shown by symbols. `.` - passed, `F` -
failed, `u` - unexpected success, `x` - expected failure. `s` - skipped;
- `1` - Show test names and doc strings;
- `2` - Show tests names and performance counters;
- `3` - Full debug output.

`Duration` option controls duration in seconds of each workload test. Use small
values to obtain results quickly add large for more heavy stress tests. Default
is `10` seconds.

`ARP`. Sometimes it is useful to reduce Linux network stack load and load
TempestaFW internals more, e.g. for performance or stress tests. That can be
achieved by populating ARP/Neighbour tables on each host. In that case all hosts
except one running testing framework must be in one subnet. See fully
distributed configuration. Possible options: `True` or `False`. Default is
`False`.

This group of options can be overridden by command line options, for more
information run tests with `-h` key.
```sh
$ ./run_tests.py -h
```

#### Client Section

`ip` - IPv4/IPv6 address of the host in test network. Used to run `wrk`,
`tempesta`, `nginx` and others with right parameters. Default is `127.0.0.1`.

`mac` - hardware address of interface in test network. Used for populating
ARP/Neighbour tables. Default is `ff:ff:ff:ff:ff:ff`, which means that ARP
feature is disabled.

`hostname`, `port`, `user` - this options describes "management" interface of
the host. Testing framework uses this fields to connect to each test node.


Options above are common for all hosts (`Client`, `Server` and `Tempesta`) and
present in each section.

`ab`, `siege` and `wrk` - absolute path to corresponding binaries.

#### Tempesta Section

Options listed in [Client Section](#client-section): `ip`, `mac`, `hostname`,
`port`, `user` are also applied to this section. Note, that the `user` must be
able to load kernel modules.

`dir` - Directory with TempestaFW sources. Must be absolute path.

#### Tempesta Section

Options listed in [Client Section](#client-section): `ip`, `mac`, `hostname`,
`port`, `user` are also applied to this section.

`nginx` - absolute path to corresponding binary.

`resourses` - absolute path to directory with sample web pages. Must be
reachable by `nginx`.


### Run tests

To run all the tests simply run:
```sh
$ ./run_tests.py
```

You can run only desired tests modules, by running:
```sh
$ python -m unittest <path to test module>
$ python -m unittest sched/test_sched_rr.py
```

## Adding new tests

Adding new tests are easy:
1. Create new Python file to new Python module (directory) or existing one.
Name of the file must be started with `test_`
```sh
$ mkdir my_test
$ touch my_test/test_some_feature.py
$ echo "__all__ = [ 'test_some_feature' ]" >> my_test/__init.py__
```
2. Import module `unittest`, and derive you test class from `tfw_test.Loader`
class from `helpers` module. Add functions started with `test_`. Test class may
have any name. Here is example of `my_test/test_some_feature.py`:
```python
import unittest
from helpers import tfw_test

class MyTester(tfw_test.Loader):
        """ Test class documentation. """

    tempesta_defconfig = 'cache 0;\n'

    def test_some_featue(self):
        """ Test documentation. """
        self.generic_test_routine(self.tempesta_defconfig)
```

Tests can be skipped or marked as expected to fail.
More info at [Python documentation](https://docs.python.org/3/library/unittest.html).

